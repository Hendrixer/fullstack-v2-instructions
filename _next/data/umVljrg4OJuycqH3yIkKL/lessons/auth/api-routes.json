{"pageProps":{"post":{"attributes":{},"html":"<h2 id=\"api-routes\">API Routes</h2>\n<p>Next we need API routes for auth</p>\n<p>For register <code>/api/register</code>:</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">NextApiRequest</span>, <span class=\"hljs-title class_\">NextApiResponse</span> } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;next&quot;</span>;\n<span class=\"hljs-keyword\">import</span> { db } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@/lib/db&quot;</span>;\n<span class=\"hljs-keyword\">import</span> { createJWT, hashPassword } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@/lib/auth&quot;</span>;\n<span class=\"hljs-keyword\">import</span> { serialize } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;cookie&quot;</span>;\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">register</span>(<span class=\"hljs-params\">\n  req: NextApiRequest,\n  res: NextApiResponse\n</span>) {\n  <span class=\"hljs-keyword\">if</span> (req.<span class=\"hljs-property\">method</span> === <span class=\"hljs-string\">&quot;POST&quot;</span>) {\n    <span class=\"hljs-keyword\">const</span> user = <span class=\"hljs-keyword\">await</span> db.<span class=\"hljs-property\">user</span>.<span class=\"hljs-title function_\">create</span>({\n      <span class=\"hljs-attr\">data</span>: {\n        <span class=\"hljs-attr\">email</span>: req.<span class=\"hljs-property\">body</span>.<span class=\"hljs-property\">email</span>,\n        <span class=\"hljs-attr\">password</span>: <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">hashPassword</span>(req.<span class=\"hljs-property\">body</span>.<span class=\"hljs-property\">password</span>),\n        <span class=\"hljs-attr\">firstName</span>: req.<span class=\"hljs-property\">body</span>.<span class=\"hljs-property\">firstName</span>,\n        <span class=\"hljs-attr\">lastName</span>: req.<span class=\"hljs-property\">body</span>.<span class=\"hljs-property\">lastName</span>,\n      },\n    });\n\n    <span class=\"hljs-keyword\">const</span> jwt = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">createJWT</span>(user);\n    res.<span class=\"hljs-title function_\">setHeader</span>(\n      <span class=\"hljs-string\">&quot;Set-Cookie&quot;</span>,\n      <span class=\"hljs-title function_\">serialize</span>(process.<span class=\"hljs-property\">env</span>.<span class=\"hljs-property\">COOKIE_NAME</span>, jwt, {\n        <span class=\"hljs-attr\">httpOnly</span>: <span class=\"hljs-literal\">true</span>,\n        <span class=\"hljs-attr\">path</span>: <span class=\"hljs-string\">&quot;/&quot;</span>,\n        <span class=\"hljs-attr\">maxAge</span>: <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">24</span> * <span class=\"hljs-number\">7</span>,\n      })\n    );\n    res.<span class=\"hljs-title function_\">status</span>(<span class=\"hljs-number\">201</span>);\n    res.<span class=\"hljs-title function_\">end</span>();\n  } <span class=\"hljs-keyword\">else</span> {\n    res.<span class=\"hljs-title function_\">status</span>(<span class=\"hljs-number\">402</span>);\n    res.<span class=\"hljs-title function_\">end</span>();\n  }\n}\n</code></pre>\n<p>For sigin <code>/api/signin</code>:</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">NextApiRequest</span>, <span class=\"hljs-title class_\">NextApiResponse</span> } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;next&quot;</span>;\n<span class=\"hljs-keyword\">import</span> { db } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@/lib/db&quot;</span>;\n<span class=\"hljs-keyword\">import</span> { comparePasswords, createJWT } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@/lib/auth&quot;</span>;\n<span class=\"hljs-keyword\">import</span> { serialize } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;cookie&quot;</span>;\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">signin</span>(<span class=\"hljs-params\">\n  req: NextApiRequest,\n  res: NextApiResponse\n</span>) {\n  <span class=\"hljs-keyword\">if</span> (req.<span class=\"hljs-property\">method</span> === <span class=\"hljs-string\">&quot;POST&quot;</span>) {\n    <span class=\"hljs-keyword\">const</span> user = <span class=\"hljs-keyword\">await</span> db.<span class=\"hljs-property\">user</span>.<span class=\"hljs-title function_\">findUnique</span>({\n      <span class=\"hljs-attr\">where</span>: {\n        <span class=\"hljs-attr\">email</span>: req.<span class=\"hljs-property\">body</span>.<span class=\"hljs-property\">email</span>,\n      },\n    });\n\n    <span class=\"hljs-keyword\">if</span> (!user) {\n      res.<span class=\"hljs-title function_\">status</span>(<span class=\"hljs-number\">401</span>);\n      res.<span class=\"hljs-title function_\">json</span>({ <span class=\"hljs-attr\">error</span>: <span class=\"hljs-string\">&quot;Invalid login&quot;</span> });\n      <span class=\"hljs-keyword\">return</span>;\n    }\n\n    <span class=\"hljs-keyword\">const</span> isUser = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">comparePasswords</span>(req.<span class=\"hljs-property\">body</span>.<span class=\"hljs-property\">password</span>, user.<span class=\"hljs-property\">password</span>);\n\n    <span class=\"hljs-keyword\">if</span> (isUser) {\n      <span class=\"hljs-keyword\">const</span> jwt = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">createJWT</span>(user);\n      res.<span class=\"hljs-title function_\">setHeader</span>(\n        <span class=\"hljs-string\">&quot;Set-Cookie&quot;</span>,\n        <span class=\"hljs-title function_\">serialize</span>(process.<span class=\"hljs-property\">env</span>.<span class=\"hljs-property\">COOKIE_NAME</span>, jwt, {\n          <span class=\"hljs-attr\">httpOnly</span>: <span class=\"hljs-literal\">true</span>,\n          <span class=\"hljs-attr\">path</span>: <span class=\"hljs-string\">&quot;/&quot;</span>,\n          <span class=\"hljs-attr\">maxAge</span>: <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">24</span> * <span class=\"hljs-number\">7</span>,\n        })\n      );\n      res.<span class=\"hljs-title function_\">status</span>(<span class=\"hljs-number\">201</span>);\n      res.<span class=\"hljs-title function_\">end</span>();\n    } <span class=\"hljs-keyword\">else</span> {\n      res.<span class=\"hljs-title function_\">status</span>(<span class=\"hljs-number\">401</span>);\n      res.<span class=\"hljs-title function_\">json</span>({ <span class=\"hljs-attr\">error</span>: <span class=\"hljs-string\">&quot;Invalid login&quot;</span> });\n    }\n  } <span class=\"hljs-keyword\">else</span> {\n    res.<span class=\"hljs-title function_\">status</span>(<span class=\"hljs-number\">402</span>);\n    res.<span class=\"hljs-title function_\">end</span>();\n  }\n}\n</code></pre>\n<blockquote>\n<p>✔️ Code Checkpoint: The current code for the application can be found on the <a href=\"https://github.com/Hendrixer/fullstack-app-v2-app/tree/auth-routes\">auth-routes branch</a>.</p>\n</blockquote>\n","slug":"api-routes","title":"Api Routes","section":"Auth","icon":"lock","filePath":"/home/runner/work/fullstack-v2-instructions/fullstack-v2-instructions/lessons/07-auth/E-api-routes.md","nextSlug":"/lessons/auth/middleware","prevSlug":"/lessons/auth/jwt"}},"__N_SSG":true}